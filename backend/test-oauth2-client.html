<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth2 ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }
        .container {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin: 0.5rem 0;
        }
        .btn:hover {
            background: #0056b3;
        }
        pre {
            background: #f1f3f4;
            padding: 1rem;
            border-radius: 4px;
            overflow-x: auto;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” noraneko-id OAuth2 ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ</h1>
    
    <div class="info">
        <strong>ğŸ“‹ ãƒ†ã‚¹ãƒˆæ‰‹é †:</strong><br>
        1. ã¾ãšç®¡ç†ç”»é¢ï¼ˆhttp://localhost:3001ï¼‰ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²<br>
        2. OAuth2ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ä½œæˆ<br>
        3. ä¸‹è¨˜ã®ã€Œã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ã‚’æ›´æ–°<br>
        4. ã€ŒOAuth2èªè¨¼é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
    </div>

    <div class="container">
        <h2>è¨­å®š</h2>
        <label>ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID:</label><br>
        <input type="text" id="clientId" placeholder="ç®¡ç†ç”»é¢ã§ä½œæˆã—ãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆID" style="width: 400px; padding: 8px; margin: 8px 0;">
        <br>
        <label>ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURI:</label><br>
        <input type="text" id="redirectUri" value="http://localhost:8082/callback" style="width: 400px; padding: 8px; margin: 8px 0;">
        <br>
        <label>ã‚¹ã‚³ãƒ¼ãƒ—:</label><br>
        <input type="text" id="scope" value="openid profile email" style="width: 400px; padding: 8px; margin: 8px 0;">
    </div>

    <div class="container">
        <h2>OAuth2 ãƒ•ãƒ­ãƒ¼ ãƒ†ã‚¹ãƒˆ</h2>
        <button class="btn" onclick="startOAuth2()">ğŸš€ OAuth2èªè¨¼é–‹å§‹</button>
        <button class="btn" onclick="clearResults()">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
        
        <h3>çµæœ:</h3>
        <div id="results"></div>
    </div>

    <div class="container">
        <h2>ğŸ“– ä½¿ç”¨æ–¹æ³•</h2>
        <h3>1. ç®¡ç†ç”»é¢ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆä½œæˆ</h3>
        <pre>
åå‰: ãƒ†ã‚¹ãƒˆã‚¢ãƒ—ãƒª
èª¬æ˜: OAuth2ãƒ•ãƒ­ãƒ¼ã®ãƒ†ã‚¹ãƒˆç”¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURI: http://localhost:8082/callback
ã‚¹ã‚³ãƒ¼ãƒ—: openid,profile,email
ã‚°ãƒ©ãƒ³ãƒˆã‚¿ã‚¤ãƒ—: authorization_code</pre>

        <h3>2. ä½œæˆã•ã‚ŒãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›</h3>
        
        <h3>3. èªè¨¼ãƒ•ãƒ­ãƒ¼ã‚’é–‹å§‹</h3>
        <p>ã€ŒOAuth2èªè¨¼é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€Goå´ã®èªè¨¼ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
    </div>

    <script>
        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è§£æ
        function getURLParams() {
            const params = new URLSearchParams(window.location.search);
            return {
                code: params.get('code'),
                state: params.get('state'),
                error: params.get('error'),
                error_description: params.get('error_description')
            };
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«èªå¯ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
        window.onload = function() {
            const params = getURLParams();
            if (params.code) {
                showResults('âœ… èªå¯ã‚³ãƒ¼ãƒ‰å–å¾—æˆåŠŸ!', `
                    <strong>èªå¯ã‚³ãƒ¼ãƒ‰:</strong> ${params.code}<br>
                    <strong>State:</strong> ${params.state || 'ãªã—'}<br>
                    <em>â€» é€šå¸¸ã¯ã“ã“ã§ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«èªå¯ã‚³ãƒ¼ãƒ‰ã‚’é€ä¿¡ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã™</em>
                `);
            } else if (params.error) {
                showResults('âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼', `
                    <strong>ã‚¨ãƒ©ãƒ¼:</strong> ${params.error}<br>
                    <strong>è©³ç´°:</strong> ${params.error_description || 'ãªã—'}
                `);
            }
        };

        function startOAuth2() {
            const clientId = document.getElementById('clientId').value;
            const redirectUri = document.getElementById('redirectUri').value;
            const scope = document.getElementById('scope').value;

            if (!clientId) {
                alert('ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            // PKCEç”¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
            const state = generateRandomString(32);
            const codeVerifier = generateRandomString(128);
            const codeChallenge = btoa(codeVerifier).replace(/\+/g, '-').replace(/\//g, '_').replace(/=/g, '');

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆå®Ÿéš›ã®ã‚¢ãƒ—ãƒªã§ã¯ã‚ˆã‚Šå®‰å…¨ãªæ–¹æ³•ã‚’ä½¿ç”¨ï¼‰
            sessionStorage.setItem('oauth2_state', state);
            sessionStorage.setItem('oauth2_code_verifier', codeVerifier);

            // OAuth2èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            const authUrl = new URL('http://localhost:8080/oauth2/authorize');
            authUrl.searchParams.set('response_type', 'code');
            authUrl.searchParams.set('client_id', clientId);
            authUrl.searchParams.set('redirect_uri', redirectUri);
            authUrl.searchParams.set('scope', scope);
            authUrl.searchParams.set('state', state);
            authUrl.searchParams.set('code_challenge', codeChallenge);
            authUrl.searchParams.set('code_challenge_method', 'S256');

            window.location.href = authUrl.toString();
        }

        function generateRandomString(length) {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            for (let i = 0; i < length; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showResults(title, content) {
            document.getElementById('results').innerHTML = `
                <div style="border: 1px solid #dee2e6; padding: 1rem; border-radius: 4px; margin: 1rem 0;">
                    <h4>${title}</h4>
                    <div>${content}</div>
                </div>
            `;
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            // URLã‹ã‚‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚ã‚¯ãƒªã‚¢
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    </script>
</body>
</html>